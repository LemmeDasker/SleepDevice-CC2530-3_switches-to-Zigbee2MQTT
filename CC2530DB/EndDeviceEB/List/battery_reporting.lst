###############################################################################
#
# IAR C/C++ Compiler V10.30.1.6000 for 8051               28/Sep/2024  20:28:31
# Copyright 2004-2018 IAR Systems AB.
# PC-locked license - IAR Embedded Workbench for 8051
#
#    Core               =  plain
#    Code model         =  banked
#    Data model         =  large
#    Calling convention =  xdata reentrant
#    Constant location  =  data_rom
#    Dptr setup         =  1,16
#                          
#    Source file        =  
#        C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\Source\battery_reporting.c
#    Command line       =  
#        -f C:\Users\Flemming\AppData\Local\Temp\EW6DD0.tmp ("C:\Texas
#        Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\Source\battery_reporting.c"
#        -D SECURE=1 -D TC_LINKKEY_JOIN -D NV_INIT -D NV_RESTORE -D
#        POWER_SAVING -D NWK_AUTO_POLL -D xZTOOL_P1 -D xMT_TASK -D xMT_APP_FUNC
#        -D xMT_SYS_FUNC -D xMT_ZDO_FUNC -D xMT_ZDO_MGMT -D xMT_APP_CNF_FUNC -D
#        xLEGACY_LCD_DEBUG -D xLCD_SUPPORTED=DEBUG -D MULTICAST_ENABLED=FALSE
#        -D ZCL_READ -D ZCL_WRITE -D ZCL_BASIC -D ZCL_IDENTIFY -D xZCL_SCENES
#        -D xZCL_GROUPS -D ZCL_ON_OFF -D xZCL_DISCOVER -D ZCL_REPORTING_DEVICE
#        -D ISR_KEYINTERRUPT -D HAL_LCD=FALSE -D HAL_UARTE=FALSE -D
#        HAL_SPI=FALSE -D HAL_HID=FALSE -lC "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\EndDeviceEB\List"
#        -lA "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\EndDeviceEB\List"
#        --diag_suppress Pe001,Pa010 -o "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\EndDeviceEB\Obj"
#        -e --debug --core=plain --dptr=16,1 --data_model=large
#        --code_model=banked --calling_convention=xdata_reentrant
#        --place_constants=data_rom --nr_virtual_regs 16 -f "C:\Texas
#        Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg"
#        (-DCPU32MHZ -DROOT=__near_func -DMAC_CFG_TX_DATA_MAX=3
#        -DMAC_CFG_TX_MAX=6 -DMAC_CFG_RX_MAX=3) -f "C:\Texas
#        Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\Tools\CC2530DB\f8wConfig.cfg"
#        (-DZIGBEEPRO -DSECURE=1 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR
#        -DDEFAULT_CHANLIST=0x00000800 -DZDAPP_CONFIG_PAN_ID=0xFFFF
#        -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MASK=0x007F
#        -DBEACON_REQUEST_DELAY=100 -DBEACON_REQ_DELAY_MASK=0x00FF
#        -DLINK_STATUS_JITTER_MASK=0x007F -DROUTE_EXPIRY_TIME=30
#        -DAPSC_ACK_WAIT_DURATION_POLLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7
#        -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3
#        -DNWK_MAX_DATA_RETRIES=2 -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9
#        -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40 -DNWK_MAX_BINDING_ENTRIES=4
#        -DMAX_BINDING_CLUSTER_IDS=4 -DDEFAULT_KEY={0} -DMAC_MAX_FRAME_SIZE=116
#        -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const __code"
#        -DGENERIC=__generic -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000
#        -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100 -DREJOIN_POLL_RATE=440
#        -DREJOIN_BACKOFF=900000 -DREJOIN_SCAN=900000 -DENABLE_LED4_DISABLE_S1)
#        -f "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\Tools\CC2530DB\f8wZCL.cfg"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\Source\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\Source\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\ZMain\TI2530DB\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\hal\include\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\hal\target\CC2530EB\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\mac\include\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\mac\high_level\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\mac\low_level\srf04\single_chip\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\mt\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\osal\include\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\services\saddr\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\services\sdata\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\af\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\bdb\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\gp\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\nwk\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\sapi\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\sec\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\sys\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\zcl\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\stack\zdo\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\zmac\"
#        -I "C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\..\..\..\..\..\Components\zmac\f8w\"
#        -Ohz --require_prototypes)
#    Locale             =  Danish_DNK.1252
#    List file          =  
#        C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\EndDeviceEB\List\battery_reporting.lst
#    Object file        =  
#        C:\Texas Instruments\Z-Stack
#        3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\CC2530DB\EndDeviceEB\Obj\battery_reporting.r51
#
###############################################################################

C:\Texas Instruments\Z-Stack 3.0.2\Projects\zstack\HomeAutomation\SleepDevice-CC2530-3_switches-to-Zigbee2MQTT\Source\battery_reporting.c
      1          //#include <stdio.h>
      2          #include <stdlib.h>
      3          
      4          #include "zcl.h"
      5          #include "zcl_genericapp.h"
      6          #include "bdb_interface.h"
      7          #include "hal_adc.h"

   \                                 In  segment SFR_AN, at 0x88
   \   union <unnamed> volatile __sfr _A_TCON
   \                     _A_TCON:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xb6
   \   unsigned char volatile __sfr ADCCON3
   \                     ADCCON3:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xba
   \   unsigned char volatile __sfr ADCL
   \                     ADCL:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xbb
   \   unsigned char volatile __sfr ADCH
   \                     ADCH:
   \   000000                DS 1
      8          
      9          #include "battery_reporting.h"
     10          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
     11          afAddrType_t zclGenericApp_Batt_DstAddr;
   \                     zclGenericApp_Batt_DstAddr:
   \   000000                DS 12
   \   00000C                REQUIRE __INIT_XDATA_Z
     12          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     13          void zclGenericApp_ReportBatt(uint8 value)
   \                     zclGenericApp_ReportBatt:
     14          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000   74F4         MOV       A,#-0xc
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 1
   \   000005   74FF         MOV       A,#-0x1
   \   000007   12....       LCALL     ?ALLOC_XSTACK8
   \   00000A   E9           MOV       A,R1
     15            uint8 MeasuredValue = value;
   \   00000B   85..82       MOV       DPL,?XSP + 0
   \   00000E   85..83       MOV       DPH,?XSP + 1
   \   000011   F0           MOVX      @DPTR,A
     16            
     17            const uint8 NUM_ATTRIBUTES = 1;
     18            zclReportCmd_t *pReportCmd;
     19            pReportCmd = osal_mem_alloc(sizeof(zclReportCmd_t) + (NUM_ATTRIBUTES * sizeof(zclReport_t)));
   \   000012                ; Setup parameters for call to function osal_mem_alloc
   \   000012   7A06         MOV       R2,#0x6
   \   000014   7B00         MOV       R3,#0x0
   \   000016   12....       LCALL     `??osal_mem_alloc::?relay`; Banked call to: osal_mem_alloc
   \   000019   8A..         MOV       ?V0,R2
   \   00001B   8B..         MOV       ?V1,R3
     20            if (pReportCmd != NULL) {
   \   00001D   EA           MOV       A,R2
   \   00001E   4B           ORL       A,R3
   \   00001F   6061         JZ        ??zclGenericApp_ReportBatt_0
     21              pReportCmd->numAttr = NUM_ATTRIBUTES;
   \   000021   8A82         MOV       DPL,R2
   \   000023   8B83         MOV       DPH,R3
   \   000025   7401         MOV       A,#0x1
   \   000027   F0           MOVX      @DPTR,A
     22          
     23              pReportCmd->attrList[0].attrID = ATTRID_POWER_CFG_BATTERY_PERCENTAGE_REMAINING;
   \   000028   A3           INC       DPTR
   \   000029   7421         MOV       A,#0x21
   \   00002B   F0           MOVX      @DPTR,A
   \   00002C   A3           INC       DPTR
   \   00002D   E4           CLR       A
   \   00002E   12....       LCALL     ?Subroutine0 & 0xFFFF
     24              pReportCmd->attrList[0].dataType = ZCL_DATATYPE_UINT8;
   \                     ??CrossCallReturnLabel_0:
   \   000031   7420         MOV       A,#0x20
   \   000033   12....       LCALL     ?Subroutine0 & 0xFFFF
     25              pReportCmd->attrList[0].attrData = (void *)(&MeasuredValue);
   \                     ??CrossCallReturnLabel_1:
   \   000036   A3           INC       DPTR
   \   000037   E5..         MOV       A,?XSP + 0
   \   000039   F0           MOVX      @DPTR,A
   \   00003A   A3           INC       DPTR
   \   00003B   E5..         MOV       A,?XSP + 1
   \   00003D   F0           MOVX      @DPTR,A
     26          
     27              zclGenericApp_Batt_DstAddr.addrMode = (afAddrMode_t)Addr16Bit;
   \   00003E   90....       MOV       DPTR,#zclGenericApp_Batt_DstAddr + 8
   \   000041   7402         MOV       A,#0x2
   \   000043   F0           MOVX      @DPTR,A
     28              zclGenericApp_Batt_DstAddr.addr.shortAddr = 0x0000;
   \   000044   90....       MOV       DPTR,#zclGenericApp_Batt_DstAddr
   \   000047   E4           CLR       A
   \   000048   F0           MOVX      @DPTR,A
   \   000049   A3           INC       DPTR
   \   00004A   F0           MOVX      @DPTR,A
     29              zclGenericApp_Batt_DstAddr.endPoint = GENERICAPP_ENDPOINT;
   \   00004B   90....       MOV       DPTR,#zclGenericApp_Batt_DstAddr + 9
   \   00004E   04           INC       A
   \   00004F   F0           MOVX      @DPTR,A
     30          
     31              zcl_SendReportCmd(GENERICAPP_ENDPOINT, &zclGenericApp_Batt_DstAddr,
     32                                ZCL_CLUSTER_ID_GEN_POWER_CFG, pReportCmd,
     33                                ZCL_FRAME_CLIENT_SERVER_DIR, TRUE, bdb_getZCLFrameCounter());
   \   000050                ; Setup parameters for call to function bdb_getZCLFrameCounter
   \   000050   12....       LCALL     `??bdb_getZCLFrameCounter::?relay`; Banked call to: bdb_getZCLFrameCounter
   \   000053   E9           MOV       A,R1
   \   000054                ; Setup parameters for call to function zcl_SendReportCmd
   \   000054   F5..         MOV       ?V2,A
   \   000056   78..         MOV       R0,#?V2
   \   000058   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00005B   75..01       MOV       ?V2,#0x1
   \   00005E   78..         MOV       R0,#?V2
   \   000060   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   000063   75..00       MOV       ?V2,#0x0
   \   000066   78..         MOV       R0,#?V2
   \   000068   12....       LCALL     ?PUSH_XSTACK_I_ONE
   \   00006B   78..         MOV       R0,#?V0
   \   00006D   12....       LCALL     ?PUSH_XSTACK_I_TWO
   \   000070   7C01         MOV       R4,#0x1
   \   000072   7D00         MOV       R5,#0x0
   \   000074   7A..         MOV       R2,#zclGenericApp_Batt_DstAddr & 0xff
   \   000076   7B..         MOV       R3,#(zclGenericApp_Batt_DstAddr >> 8) & 0xff
   \   000078   7901         MOV       R1,#0x1
   \   00007A   12....       LCALL     `??zcl_SendReportCmd::?relay`; Banked call to: zcl_SendReportCmd
   \   00007D   7405         MOV       A,#0x5
   \   00007F   12....       LCALL     ?DEALLOC_XSTACK8
     34            }
     35          
     36            osal_mem_free(pReportCmd);
   \                     ??zclGenericApp_ReportBatt_0:
   \   000082                ; Setup parameters for call to function osal_mem_free
   \   000082   AA..         MOV       R2,?V0
   \   000084   AB..         MOV       R3,?V1
   \   000086   12....       LCALL     `??osal_mem_free::?relay`; Banked call to: osal_mem_free
     37          }
   \   000089   7401         MOV       A,#0x1
   \   00008B   12....       LCALL     ?DEALLOC_XSTACK8
   \   00008E   7F04         MOV       R7,#0x4
   \   000090   02....       LJMP      ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   F0           MOVX      @DPTR,A
   \   000001   8A82         MOV       DPL,R2
   \   000003   8B83         MOV       DPH,R3
   \   000005   A3           INC       DPTR
   \   000006   A3           INC       DPTR
   \   000007   A3           INC       DPTR
   \   000008   22           RET
     38          
     39          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
     40          void zclGenericApp_ReadADC(void)
   \                     zclGenericApp_ReadADC:
     41          {
   \   000000                REQUIRE ?V0
   \   000000                REQUIRE ?V1
   \   000000                REQUIRE ?V2
   \   000000                REQUIRE ?V3
   \   000000                REQUIRE ?V4
   \   000000                REQUIRE ?V5
   \   000000                REQUIRE ?V6
   \   000000                REQUIRE ?V7
   \   000000   74F0         MOV       A,#-0x10
   \   000002   12....       LCALL     ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
     42          uint16 ADC_value = 0;
     43          uint16 accumulator = 0;
   \   000005   7A00         MOV       R2,#0x0
   \   000007   7B00         MOV       R3,#0x0
     44          uint16 value = 0;
     45          float voltage = 0.0;
     46          uint8 percent = 0;
     47          
     48          
     49          uint16 min = 270;       // minimum voltage = 0%
     50          uint16 max = 300;       // maximum voltage = 100%
     51          
     52          int i = 0;
   \   000009   7C0A         MOV       R4,#0xa
     53          while (i < 10) {
     54            /* Clear ADC interrupt flag */
     55            ADCIF = 0;
   \                     ??zclGenericApp_ReadADC_0:
   \   00000B   C28D         CLR       0x88.5
     56            /* Do the conversion */
     57            ADCCON3 = (HAL_ADC_REF_125V | HAL_ADC_RESOLUTION_10 | HAL_ADC_CHN_VDD3);
   \   00000D   75B60F       MOV       0xb6,#0xf
     58            /* Wait for the conversion to finish */
     59            while ( !ADCIF );
   \                     ??zclGenericApp_ReadADC_1:
   \   000010   A28D         MOV       C,0x88.5
   \   000012   50FC         JNC       ??zclGenericApp_ReadADC_1
     60            /* Get the result */
     61            value = ADCL;
   \   000014   E5BA         MOV       A,0xba+0x0
     62            value |= ((uint16) ADCH) << 8;
     63            /* Adjust for 10 bit resolution */
     64            value >>= 6;
     65            accumulator = accumulator + value;
   \   000016   A9BB         MOV       R1,0xbb
   \   000018   F5..         MOV       ?V0,A
   \   00001A   E9           MOV       A,R1
   \   00001B   F5..         MOV       ?V1,A
   \   00001D   7406         MOV       A,#0x6
   \   00001F   78..         MOV       R0,#?V0
   \   000021   12....       LCALL     ?US_SHR
   \   000024   EA           MOV       A,R2
   \   000025   25..         ADD       A,?V0
   \   000027   FA           MOV       R2,A
   \   000028   EB           MOV       A,R3
   \   000029   35..         ADDC      A,?V1
   \   00002B   FB           MOV       R3,A
     66            i++;
     67          }
   \   00002C   1C           DEC       R4
   \   00002D   EC           MOV       A,R4
   \   00002E   70DB         JNZ       ??zclGenericApp_ReadADC_0
     68          
     69          ADC_value = accumulator / 10;            // find average of 10 samples
     70          //printf("ADC_value = %d\n", ADC_value);
     71          
     72          voltage = (1.15*ADC_value)/511*3;        // convert to voltage - etc.3.0587
     73          //printf("Volt = %f\n", voltage);
     74          
     75          voltage = voltage + 0.15;                // compensate for ADC measurement vs.actual battery value
     76          //printf("Volt = %f\n", voltage);  
     77          
     78          value = (int)(voltage * 100);            // convert to simpel voltage - etc.318
   \   000030   EA           MOV       A,R2
   \   000031   F8           MOV       R0,A
   \   000032   EB           MOV       A,R3
   \   000033   F9           MOV       R1,A
   \   000034   7A0A         MOV       R2,#0xa
   \   000036   7B00         MOV       R3,#0x0
   \   000038   12....       LCALL     ?US_DIV_MOD
   \   00003B   88..         MOV       ?V0,R0
   \   00003D   89..         MOV       ?V1,R1
   \   00003F   E4           CLR       A
   \   000040   F5..         MOV       ?V2,A
   \   000042   F5..         MOV       ?V3,A
   \   000044   78..         MOV       R0,#?V0
   \   000046   12....       LCALL     ?UL_TO_FLT
   \   000049   90....       MOV       DPTR,#__Constant_3f933333
   \   00004C   78..         MOV       R0,#?V4
   \   00004E   12....       LCALL     ?L_MOV_X
   \   000051   78..         MOV       R0,#?V0
   \   000053   79..         MOV       R1,#?V4
   \   000055   12....       LCALL     ?FLT_MUL
   \   000058   90....       MOV       DPTR,#__Constant_43ff8000
   \   00005B   78..         MOV       R0,#?V4
   \   00005D   12....       LCALL     ?L_MOV_X
   \   000060   78..         MOV       R0,#?V0
   \   000062   79..         MOV       R1,#?V4
   \   000064   12....       LCALL     ?FLT_DIV
   \   000067   90....       MOV       DPTR,#__Constant_40400000
   \   00006A   78..         MOV       R0,#?V4
   \   00006C   12....       LCALL     ?L_MOV_X
   \   00006F   78..         MOV       R0,#?V0
   \   000071   79..         MOV       R1,#?V4
   \   000073   12....       LCALL     ?FLT_MUL
   \   000076   90....       MOV       DPTR,#__Constant_3e19999a
   \   000079   78..         MOV       R0,#?V4
   \   00007B   12....       LCALL     ?L_MOV_X
   \   00007E   78..         MOV       R0,#?V0
   \   000080   79..         MOV       R1,#?V4
   \   000082   12....       LCALL     ?FLT_ADD
   \   000085   90....       MOV       DPTR,#__Constant_42c80000
   \   000088   78..         MOV       R0,#?V4
   \   00008A   12....       LCALL     ?L_MOV_X
   \   00008D   78..         MOV       R0,#?V0
   \   00008F   79..         MOV       R1,#?V4
   \   000091   12....       LCALL     ?FLT_MUL
   \   000094   78..         MOV       R0,#?V0
   \   000096   12....       LCALL     ?FLT_TO_L
   \   000099   A8..         MOV       R0,?V0
   \   00009B   A9..         MOV       R1,?V1
     79          //printf("Voltage in INT = %d\n", value);    
     80          
     81          if (value >= max) {value = max;}         // keep value within max range
   \   00009D   C3           CLR       C
   \   00009E   E8           MOV       A,R0
   \   00009F   942C         SUBB      A,#0x2c
   \   0000A1   E9           MOV       A,R1
   \   0000A2   9401         SUBB      A,#0x1
   \   0000A4   4004         JC        ??zclGenericApp_ReadADC_2
   \   0000A6   782C         MOV       R0,#0x2c
   \   0000A8   800B         SJMP      ??zclGenericApp_ReadADC_3
     82          if (value <= min) {value = min;}         // keep value within min range
   \                     ??zclGenericApp_ReadADC_2:
   \   0000AA   C3           CLR       C
   \   0000AB   E8           MOV       A,R0
   \   0000AC   940F         SUBB      A,#0xf
   \   0000AE   E9           MOV       A,R1
   \   0000AF   9401         SUBB      A,#0x1
   \   0000B1   5004         JNC       ??zclGenericApp_ReadADC_4
   \   0000B3   780E         MOV       R0,#0xe
   \                     ??zclGenericApp_ReadADC_3:
   \   0000B5   7901         MOV       R1,#0x1
     83          //printf("Voltage in min-max range = %d\n", value);
     84          
     85          percent = (uint8)(((value - min) * 100) / (max - min)); // Beregning af procentdel
   \                     ??zclGenericApp_ReadADC_4:
   \   0000B7   E8           MOV       A,R0
   \   0000B8   24F2         ADD       A,#-0xe
   \   0000BA   F8           MOV       R0,A
   \   0000BB   E9           MOV       A,R1
   \   0000BC   34FE         ADDC      A,#-0x2
   \   0000BE   F9           MOV       R1,A
   \   0000BF   E8           MOV       A,R0
   \   0000C0   75F064       MOV       B,#0x64
   \   0000C3   A4           MUL       AB
   \   0000C4   F8           MOV       R0,A
   \   0000C5   AAF0         MOV       R2,B
   \   0000C7   75F064       MOV       B,#0x64
   \   0000CA   E9           MOV       A,R1
   \   0000CB   A4           MUL       AB
   \   0000CC   2A           ADD       A,R2
   \   0000CD   F9           MOV       R1,A
   \   0000CE   7A1E         MOV       R2,#0x1e
   \   0000D0   7B00         MOV       R3,#0x0
   \   0000D2   12....       LCALL     ?US_DIV_MOD
   \   0000D5   E8           MOV       A,R0
   \   0000D6   F8           MOV       R0,A
     86          percent = percent - (percent % 5);                      // Afrunding til nærmeste 5%
     87          //printf("Percent = %d\n", percent);
     88          
     89          percent = percent * 2; // adjust to Zigbee2MQTT percent reader
     90          //printf("Percent = %d\n", percent); 
     91          
     92          zclGenericApp_ReportBatt(percent);
   \   0000D7                ; Setup parameters for call to function zclGenericApp_ReportBatt
   \   0000D7   75F005       MOV       B,#0x5
   \   0000DA   84           DIV       AB
   \   0000DB   A9F0         MOV       R1,B
   \   0000DD   E8           MOV       A,R0
   \   0000DE   99           SUBB      A,R1
   \   0000DF   C3           CLR       C
   \   0000E0   33           RLC       A
   \   0000E1   F9           MOV       R1,A
   \   0000E2   12....       LCALL     `??zclGenericApp_ReportBatt::?relay`; Banked call to: zclGenericApp_ReportBatt
     93          }
   \   0000E5   7F08         MOV       R7,#0x8
   \   0000E7   02....       LJMP      ?BANKED_LEAVE_XDATA
   \   0000EA                REQUIRE _A_TCON
   \   0000EA                REQUIRE ADCCON3
   \   0000EA                REQUIRE ADCL
   \   0000EA                REQUIRE ADCH

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_3f933333:
   \   000000   3333933F     DD 3F933333H

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_43ff8000:
   \   000000   0080FF43     DD 43FF8000H

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_40400000:
   \   000000   00004040     DD 40400000H

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_3e19999a:
   \   000000   9A99193E     DD 3E19999AH

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_42c80000:
   \   000000   0000C842     DD 42C80000H

   Maximum stack usage in bytes:

   ISTACK XSTACK Function
   ------ ------ --------
      0     16   zclGenericApp_ReadADC
        0     16   -> zclGenericApp_ReportBatt
      1     34   zclGenericApp_ReportBatt
        0     13   -> bdb_getZCLFrameCounter
        0     13   -> osal_mem_alloc
        0     13   -> osal_mem_free
        0     18   -> zcl_SendReportCmd


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       9  ?Subroutine0
       1  ADCCON3
       1  ADCH
       1  ADCL
       1  _A_TCON
       4  __Constant_3e19999a
       4  __Constant_3f933333
       4  __Constant_40400000
       4  __Constant_42c80000
       4  __Constant_43ff8000
      12  zclGenericApp_Batt_DstAddr
     234  zclGenericApp_ReadADC
     147  zclGenericApp_ReportBatt
      12  -- Other

 
 390 bytes in segment BANKED_CODE
  12 bytes in segment BANK_RELAYS
   4 bytes in segment SFR_AN
  20 bytes in segment XDATA_ROM_C
  12 bytes in segment XDATA_Z
 
  12 bytes of CODE     memory
   0 bytes of CONST    memory (+ 20 bytes shared)
   0 bytes of DATA     memory (+  4 bytes shared)
 390 bytes of HUGECODE memory
  12 bytes of XDATA    memory

Errors: none
Warnings: none
